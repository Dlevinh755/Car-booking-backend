<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Taxi MVP - Dashboard ƒêi·ªÅu Ph·ªëi</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1000px; margin: 24px auto; padding: 0 16px; background-color: #f4f7f6; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-bottom: 10px; }
    .card { background: white; border-radius: 12px; padding: 20px; margin-top: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h3 { margin-top: 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 8px; }
    input, select, button { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; }
    button { background-color: #007bff; color: white; border: none; transition: 0.2s; }
    button:hover { background-color: #0056b3; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    .muted { color: #666; font-size: 13px; }
    .ok { color: #28a745; font-weight: bold; }
    .warn { color: #fd7e14; font-weight: bold; }
    .err { color: #dc3545; font-weight: bold; }
    .info { color: #17a2b8; font-weight: bold; }
    pre { background: #272822; color: #f8f8f2; padding: 12px; border-radius: 8px; overflow: auto; max-height: 200px; font-size: 12px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    #notification-area { border-left: 4px solid #007bff; background: #e7f3ff; padding: 10px; margin-top: 10px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>üöï Taxi MVP - Test Booking System</h1>

  <div class="card">
    <h3>1. C·∫•u h√¨nh h·ªá th·ªëng</h3>
    <div class="row">
      <div>
        <label class="muted">Pricing API</label><br>
        <input id="pricingBase" style="width:200px;" value="http://localhost:8002" />
      </div>
      <div>
        <label class="muted">Booking API</label><br>
        <input id="bookingBase" style="width:200px;" value="http://localhost:8003" />
      </div>
      <div>
        <label class="muted">Notify (SSE) API</label><br>
        <input id="notifyBase" style="width:200px;" value="http://localhost:8006" />
      </div>
      <div>
        <label class="muted">User ID (ƒê·ªÉ nh·∫≠n SSE)</label><br>
        <input id="userId" style="width:120px;" value="u1" />
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>2. V·ªã tr√≠ ƒë·∫∑t xe</h3>
      <div class="row">
        <strong>Pickup:</strong>
        <input id="pLat" type="number" step="0.000001" style="width:90px;" value="10.762622" />
        <input id="pLng" type="number" step="0.000001" style="width:90px;" value="106.660172" />
        <button id="btnGeo" style="background:#6c757d">üìç</button>
      </div>
      <div class="row">
        <strong>Dropoff:</strong>
        <input id="dLat" type="number" step="0.000001" style="width:90px;" value="10.762" />
        <input id="dLng" type="number" step="0.000001" style="width:90px;" value="106.682" />
      </div>
      <div class="row">
        <label>Lo·∫°i xe:</label>
        <select id="vehicleType">
          <option value="CAR_4">Xe 4 ch·ªó</option>
          <option value="CAR_7">Xe 7 ch·ªó</option>
        </select>
        <label>Thanh to√°n:</label>
        <select id="paymentMethod">
          <option value="CASH">Ti·ªÅn m·∫∑t</option>
          <option value="VNPAY">VNPAY</option>
        </select>
      </div>
      <hr>
      <div class="row">
        <button id="btnEstimate">B∆∞·ªõc 1: T√≠nh gi√°</button>
        <button id="btnCreate" disabled style="background:#28a745">B∆∞·ªõc 2: ƒê·∫∑t xe ngay</button>
      </div>
    </div>

    <div class="card">
      <h3>3. Tr·∫°ng th√°i th·ªùi gian th·ª±c (SSE)</h3>
      <div id="notification-area">
        <strong>üì° Th√¥ng b√°o:</strong> <span id="notifyMsg">Ch∆∞a k·∫øt n·ªëi SSE</span>
      </div>
      <p>Booking ID: <span id="bookingId" class="ok">-</span></p>
      <p>Tr·∫°ng th√°i: <span id="bookingStatus" class="warn">N/A</span></p>
      <p>Driver ID: <span id="driverId" class="info">-</span></p>
      <div class="row">
        <button id="btnPoll" disabled style="background:#17a2b8">B·∫≠t Polling</button>
        <button id="btnStop" disabled style="background:#dc3545">D·ª´ng Poll</button>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>K·∫øt qu·∫£ Estimate</h3>
      <div id="estimateLine" class="info">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
      <pre id="estimateJson">{}</pre>
    </div>
    <div class="card">
      <h3>Nh·∫≠t k√Ω h·ªá th·ªëng (Logs)</h3>
      <pre id="logs" style="height: 150px; background: #000;">[SYSTEM] Ready...</pre>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    let lastEstimate = null;
    let currentBookingId = null;
    let pollTimer = null;
    let eventSource = null;

    function log(msg, type = 'info') {
      const ts = new Date().toLocaleTimeString();
      const line = `[${ts}] ${msg}\n`;
      $("logs").textContent = line + $("logs").textContent;
      console.log(`[${type}] ${msg}`);
    }

    // --- SSE Logic ---
    function startSSE(userId) {
      if (eventSource) eventSource.close();
      const url = `${$("notifyBase").value}/notifications/stream?role=USER&userId=${userId}`;
      eventSource = new EventSource(url);

      $("notification-area").style.display = "block";
      $("notifyMsg").innerHTML = `<span class="info">ƒêang k·∫øt n·ªëi SSE cho User: ${userId}...</span>`;
      log("ƒêang k·∫øt n·ªëi SSE cho User: " + userId);
      
      eventSource.onopen = () => {
        $("notifyMsg").innerHTML = `<span class="ok">‚úÖ K·∫øt n·ªëi SSE th√†nh c√¥ng! ƒêang ch·ªù th√¥ng b√°o...</span>`;
        log("SSE: K·∫øt n·ªëi th√†nh c√¥ng", "ok");
      };

      // Listen for booking events
      eventSource.addEventListener("booking", (e) => {
        const evt = JSON.parse(e.data);
        const eventType = evt.eventType || "UNKNOWN";
        log(`SSE: Booking event - ${eventType}`);
        
        if (eventType === "BOOKING_CREATED") {
          $("notifyMsg").innerHTML = `<b class="ok">‚úÖ ƒê∆°n ƒë·∫∑t xe ƒë√£ ƒë∆∞·ª£c t·∫°o!</b>`;
        } else if (eventType === "BOOKING_MATCH_REQUESTED") {
          $("notifyMsg").innerHTML = `<b class="info">üîç ƒêang t√¨m t√†i x·∫ø g·∫ßn b·∫°n...</b>`;
        }
      });

      // Ride accepted by driver
      eventSource.addEventListener("ride_accepted", (e) => {
        const evt = JSON.parse(e.data);
        const driverId = evt.payload?.driverId || "N/A";
        $("driverId").textContent = driverId;
        $("bookingStatus").textContent = "DRIVER_ASSIGNED";
        $("notifyMsg").innerHTML = `<b class="ok">üöó T√†i x·∫ø ${driverId} ƒë√£ nh·∫≠n chuy·∫øn!</b>`;
        log(`SSE: T√†i x·∫ø ${driverId} nh·∫≠n chuy·∫øn`, "ok");
      });

      // Ride completed
      eventSource.addEventListener("ride_completed", (e) => {
        $("bookingStatus").textContent = "COMPLETED";
        $("notifyMsg").innerHTML = `<b class="info">üèÅ Chuy·∫øn ƒëi ho√†n th√†nh!</b>`;
        log("SSE: Chuy·∫øn ƒëi ho√†n th√†nh", "ok");
        stopPoll();
      });

      // SSE errors
      eventSource.onerror = (err) => {
        $("notifyMsg").innerHTML = `<span class="err">‚ùå L·ªói k·∫øt n·ªëi SSE</span>`;
        log("SSE Connection Error", "err");
        console.error("SSE Error:", err);
      };

      // Heartbeat ping (optional - just for logging)
      eventSource.addEventListener("ping", () => {
        console.log("SSE: Heartbeat ping");
      });
    }

    // --- Core Logic ---
    $("btnEstimate").onclick = async () => {
      const pricingBase = $("pricingBase").value;
      const body = {
        pickup: { lat: Number($("pLat").value), lng: Number($("pLng").value) },
        dropoff: { lat: Number($("dLat").value), lng: Number($("dLng").value) },
        vehicleType: $("vehicleType").value
      };

      try {
        const res = await fetch(`${pricingBase}/pricing/estimate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "L·ªói estimate");

        lastEstimate = data;
        $("estimateJson").textContent = JSON.stringify(data, null, 2);
        $("estimateLine").textContent = `${(data.distanceM/1000).toFixed(2)}km - ${Math.round(data.durationS/60)} ph√∫t - ${Number(data.fare).toLocaleString()} ${data.currency}`;
        $("btnCreate").disabled = false;
        log("Estimate th√†nh c√¥ng");
      } catch (e) {
        log(e.message, "err");
      }
    };

    $("btnCreate").onclick = async () => {
      const bookingBase = $("bookingBase").value;
      const userId = $("userId").value;
      
      const body = {
        userId: userId,
        pickup: { lat: Number($("pLat").value), lng: Number($("pLng").value) },
        dropoff: { lat: Number($("dLat").value), lng: Number($("dLng").value) },
        vehicleType: $("vehicleType").value,
        paymentMethod: $("paymentMethod").value,
        pricingSnapshot: lastEstimate
      };

      try {
        const res = await fetch(`${bookingBase}/bookings`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "L·ªói t·∫°o booking");

        currentBookingId = data.bookingId;
        $("bookingId").textContent = currentBookingId;
        $("bookingStatus").textContent = data.status;
        $("btnPoll").disabled = false;
        
        log("Booking th√†nh c√¥ng: " + currentBookingId);
        startSSE(userId); // T·ª± ƒë·ªông b·∫≠t th√¥ng b√°o real-time
      } catch (e) {
        log(e.message, "err");
      }
    };

    async function checkStatus() {
      if (!currentBookingId) return;
      try {
        const res = await fetch(`${$("bookingBase").value}/bookings/${currentBookingId}`);
        const data = await res.json();
        $("bookingStatus").textContent = data.status;
        log("Polling status: " + data.status);
        if (data.status === "COMPLETED" || data.status === "CANCELLED") stopPoll();
      } catch (e) { log("Poll error", "err"); }
    }

    $("btnPoll").onclick = () => {
      checkStatus();
      pollTimer = setInterval(checkStatus, 3000);
      $("btnPoll").disabled = true;
      $("btnStop").disabled = false;
      log("B·∫Øt ƒë·∫ßu Polling...");
    };

    function stopPoll() {
      clearInterval(pollTimer);
      $("btnPoll").disabled = false;
      $("btnStop").disabled = true;
      log("D·ª´ng Polling.");
    }

    $("btnStop").onclick = stopPoll;
    
    // Geolocation
    $("btnGeo").onclick = () => {
      navigator.geolocation.getCurrentPosition(pos => {
        $("pLat").value = pos.coords.latitude.toFixed(6);
        $("pLng").value = pos.coords.longitude.toFixed(6);
      });
    };
  </script>
</body>
</html>