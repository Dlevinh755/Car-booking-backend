<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Taxi MVP - Pricing</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 760px; margin: 24px auto; padding: 0 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-top: 12px; }
    input, select, button { padding: 10px; border-radius: 10px; border: 1px solid #ccc; }
    button { cursor: pointer; }
    .muted { color: #666; font-size: 14px; }
    pre { background: #f6f6f6; padding: 12px; border-radius: 10px; overflow:auto; }
  </style>
</head>
<body>
  <h1>Slice #1 – Pricing</h1>
  <p class="muted">Nhập pickup/dropoff lat,lng rồi bấm “Ước tính giá”.</p>

  <div class="card">
    <h3>Pickup</h3>
    <div class="row">
      <input id="pLat" type="number" step="0.000001" placeholder="lat" value="10.775" />
      <input id="pLng" type="number" step="0.000001" placeholder="lng" value="106.700" />
      <button id="btnGeo">Lấy vị trí hiện tại</button>
    </div>

    <h3 style="margin-top:16px;">Dropoff</h3>
    <div class="row">
      <input id="dLat" type="number" step="0.000001" placeholder="lat" value="10.762" />
      <input id="dLng" type="number" step="0.000001" placeholder="lng" value="106.682" />
    </div>

    <div class="row" style="margin-top:16px; align-items:center;">
      <select id="vehicleType">
        <option value="CAR_4">CAR_4</option>
        <option value="CAR_7">CAR_7</option>
      </select>

      <button id="btnEstimate">Ước tính giá</button>
    </div>
  </div>

  <div class="card">
    <h3>Kết quả</h3>
    <div id="result" class="muted">Chưa có</div>
    <pre id="json"></pre>
  </div>

  <script>
    const API_BASE = "http://localhost:8002";

    const $ = (id) => document.getElementById(id);

    $("btnGeo").onclick = () => {
      if (!navigator.geolocation) {
        alert("Trình duyệt không hỗ trợ geolocation");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          $("pLat").value = pos.coords.latitude.toFixed(6);
          $("pLng").value = pos.coords.longitude.toFixed(6);
        },
        (err) => alert("Không lấy được vị trí: " + err.message),
        { enableHighAccuracy: true, timeout: 8000 }
      );
    };

    $("btnEstimate").onclick = async () => {
      const pickup = { lat: Number($("pLat").value), lng: Number($("pLng").value) };
      const dropoff = { lat: Number($("dLat").value), lng: Number($("dLng").value) };
      const vehicleType = $("vehicleType").value;

      $("result").textContent = "Đang tính...";
      $("json").textContent = "";

      try {
        const res = await fetch(`${API_BASE}/pricing/estimate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ pickup, dropoff, vehicleType })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Estimate failed");

        const km = (data.distanceM / 1000).toFixed(2);
        const min = Math.round(data.durationS / 60);

        $("result").textContent =
          `Khoảng cách ~ ${km} km • ${min} phút • Giá: ${data.fare.toLocaleString("vi-VN")} ${data.currency}`;
        $("json").textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        $("result").textContent = "Lỗi: " + e.message;
      }
    };
  </script>
</body>
</html>