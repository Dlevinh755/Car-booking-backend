<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SSE Test - Driver Notifications</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    .log { background: #f0f0f0; padding: 10px; margin: 5px 0; border-left: 3px solid #333; }
    .log.ride_offer { border-left-color: #4CAF50; background: #e8f5e9; }
    .log.ride_accepted { border-left-color: #2196F3; background: #e3f2fd; }
    .log.ride_completed { border-left-color: #FF9800; background: #fff3e0; }
    .log.error { border-left-color: #f44336; background: #ffebee; }
    button { padding: 10px 20px; margin: 5px; font-size: 14px; cursor: pointer; }
    #eventLog { max-height: 500px; overflow-y: auto; }
  </style>
</head>
<body>
  <h1>Driver SSE Test</h1>
  
  <div>
    <button onclick="startDriverSSE('d1')">Start Driver d1 SSE</button>
    <button onclick="startDriverSSE('d2')">Start Driver d2 SSE</button>
    <button onclick="stopSSE()">Stop SSE</button>
    <button onclick="clearLog()">Clear Log</button>
  </div>
  
  <div>
    <button onclick="createTestBooking()">Create Test Booking (SEDAN, CASH)</button>
    <button onclick="createTestBooking('SUV')">Create Test Booking (SUV, CASH)</button>
  </div>
  
  <h2>Event Log</h2>
  <div id="eventLog"></div>

  <script>
    let eventSource = null;
    let currentDriver = null;

    function log(message, className = '') {
      const div = document.createElement('div');
      div.className = 'log ' + className;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      document.getElementById('eventLog').prepend(div);
      console.log(message);
    }

    function startDriverSSE(driverId) {
      if (eventSource) {
        log('Closing existing SSE connection...', 'error');
        eventSource.close();
      }

      currentDriver = driverId;
      const url = `http://localhost:8006/notifications/stream?role=DRIVER&driverId=${driverId}`;
      
      log(`Connecting to SSE: ${url}`, '');
      
      eventSource = new EventSource(url);

      eventSource.onopen = () => {
        log(`âœ… SSE connected for driver ${driverId}`, '');
      };

      eventSource.onerror = (e) => {
        log(`âŒ SSE error: ${e.message || 'Connection failed'}`, 'error');
        console.error('SSE error:', e);
      };

      // Listen for specific event types
      eventSource.addEventListener('ride_offer', (e) => {
        const data = JSON.parse(e.data);
        log(`ðŸš— RIDE_OFFER: ${JSON.stringify(data, null, 2)}`, 'ride_offer');
      });

      eventSource.addEventListener('ride_accepted', (e) => {
        const data = JSON.parse(e.data);
        log(`âœ… RIDE_ACCEPTED: ${JSON.stringify(data, null, 2)}`, 'ride_accepted');
      });

      eventSource.addEventListener('ride_completed', (e) => {
        const data = JSON.parse(e.data);
        log(`ðŸ RIDE_COMPLETED: ${JSON.stringify(data, null, 2)}`, 'ride_completed');
      });

      eventSource.addEventListener('ping', (e) => {
        // Heartbeat - don't log to reduce noise
        console.log('Heartbeat ping received');
      });

      // Generic message handler
      eventSource.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data);
          log(`ðŸ“¨ Generic message: ${JSON.stringify(data, null, 2)}`, '');
        } catch (err) {
          log(`ðŸ“¨ Message: ${e.data}`, '');
        }
      };
    }

    function stopSSE() {
      if (eventSource) {
        eventSource.close();
        log('SSE connection closed', '');
        eventSource = null;
        currentDriver = null;
      } else {
        log('No active SSE connection', 'error');
      }
    }

    function clearLog() {
      document.getElementById('eventLog').innerHTML = '';
    }

    async function createTestBooking(vehicleType = 'SEDAN') {
      try {
        log(`Creating test booking (${vehicleType})...`, '');
        
        const booking = {
          userId: 'u1',
          pickup: {
            lat: 10.762622,
            lng: 106.660172,
            address: "Test Pickup Location"
          },
          dropoff: {
            lat: 10.771928,
            lng: 106.698229,
            address: "Test Dropoff Location"
          },
          vehicleType: vehicleType,
          paymentMethod: "CASH",
          pricingSnapshot: {
            fare: 50000,
            distanceM: 5000,
            durationS: 900,
            currency: "VND"
          }
        };

        const response = await fetch('http://localhost:8003/bookings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(booking)
        });

        const result = await response.json();
        
        if (response.ok) {
          log(`âœ… Booking created: ${result.bookingId}`, '');
        } else {
          log(`âŒ Booking failed: ${result.error}`, 'error');
        }
      } catch (err) {
        log(`âŒ Request failed: ${err.message}`, 'error');
      }
    }

    // Auto-start on page load
    window.addEventListener('DOMContentLoaded', () => {
      log('Page loaded. Click "Start Driver d1 SSE" to connect', '');
    });
  </script>
</body>
</html>
