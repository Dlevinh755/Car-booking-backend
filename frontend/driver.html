<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Taxi Driver Dashboard</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      max-width: 1200px; 
      margin: 24px auto; 
      padding: 0 16px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
    .card { 
      background: #f8f9fa; 
      border-radius: 12px; 
      padding: 20px; 
      border: 2px solid #e9ecef;
    }
    h1 { margin: 0 0 10px 0; color: #333; }
    h2 { 
      margin: 0 0 16px 0; 
      color: #495057; 
      font-size: 18px; 
      border-bottom: 2px solid #dee2e6; 
      padding-bottom: 8px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 3px solid #e9ecef;
    }
    .driver-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .driver-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      font-weight: bold;
    }
    .status-badge {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      text-transform: uppercase;
    }
    .status-online { background: #28a745; color: white; }
    .status-busy { background: #ffc107; color: #000; }
    .status-offline { background: #6c757d; color: white; }
    
    .form-row { 
      display: flex; 
      gap: 12px; 
      margin-bottom: 12px; 
      align-items: flex-end;
    }
    .form-group {
      flex: 1;
    }
    label { 
      display: block; 
      font-size: 13px; 
      color: #6c757d; 
      margin-bottom: 4px;
      font-weight: 500;
    }
    input, select { 
      width: 100%; 
      padding: 10px; 
      border: 2px solid #dee2e6; 
      border-radius: 8px; 
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }
    button { 
      padding: 10px 20px; 
      border-radius: 8px; 
      border: none; 
      font-size: 14px; 
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
    }
    .btn-primary { background: #007bff; color: white; }
    .btn-primary:hover { background: #0056b3; transform: translateY(-1px); }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #1e7e34; }
    .btn-warning { background: #ffc107; color: #000; }
    .btn-warning:hover { background: #e0a800; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover { background: #c82333; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #5a6268; }
    .btn-info { background: #17a2b8; color: white; }
    .btn-info:hover { background: #138496; }
    
    button:disabled { 
      background: #e9ecef; 
      color: #6c757d;
      cursor: not-allowed;
      transform: none;
    }
    
    .notification {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      border-left: 4px solid;
    }
    .notification.info { background: #e7f3ff; border-color: #007bff; color: #004085; }
    .notification.success { background: #d4edda; border-color: #28a745; color: #155724; }
    .notification.warning { background: #fff3cd; border-color: #ffc107; color: #856404; }
    .notification.error { background: #f8d7da; border-color: #dc3545; color: #721c24; }
    
    #sse-log {
      max-height: 300px;
      overflow-y: auto;
      font-size: 13px;
    }
    .log-entry {
      padding: 8px;
      margin-bottom: 4px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      background: white;
      border-left: 3px solid #dee2e6;
    }
    .log-entry.ride_offer { border-left-color: #28a745; background: #d4edda; }
    .log-entry.ride_accepted { border-left-color: #007bff; background: #cfe2ff; }
    .log-entry.ride_completed { border-left-color: #fd7e14; background: #ffe5d0; }
    .log-entry.error { border-left-color: #dc3545; background: #f8d7da; }
    
    .stats {
      display: flex;
      gap: 16px;
      margin-top: 16px;
    }
    .stat-card {
      flex: 1;
      background: white;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    .stat-label {
      font-size: 12px;
      color: #6c757d;
      text-transform: uppercase;
      margin-top: 4px;
    }
    
    pre {
      background: #272822;
      color: #f8f8f2;
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 12px;
      max-height: 200px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="driver-info">
        <div class="driver-avatar" id="driver-avatar">D</div>
        <div>
          <h1>üöó Driver Dashboard</h1>
          <div style="font-size: 14px; color: #6c757d;">
            Driver ID: <strong id="display-driver-id">-</strong> | 
            Status: <span class="status-badge status-offline" id="status-badge">OFFLINE</span>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Left Column -->
      <div>
        <div class="card">
          <h2>‚öôÔ∏è C·∫•u h√¨nh Driver</h2>
          <div class="form-group">
            <label>Driver ID</label>
            <input type="text" id="driver-id" value="d1" placeholder="Nh·∫≠p Driver ID (vd: d1, d2)">
          </div>
          <div class="form-group">
            <label>Lo·∫°i xe</label>
            <select id="vehicle-type">
              <option value="CAR_4">CAR_4 (Xe 4 ch·ªó)</option>
              <option value="CAR_7">CAR_7 (Xe 7 ch·ªó)</option>
            </select>
          </div>
          <div class="form-row">
            <button class="btn-primary" id="btn-apply" style="flex: 1;">‚úÖ √Åp d·ª•ng</button>
          </div>
        </div>

        <div class="card" style="margin-top: 16px;">
          <h2>üìç V·ªã tr√≠ hi·ªán t·∫°i</h2>
          <div class="form-row">
            <div class="form-group">
              <label>Latitude</label>
              <input type="number" id="lat" step="0.000001" value="10.762622">
            </div>
            <div class="form-group">
              <label>Longitude</label>
              <input type="number" id="lng" step="0.000001" value="106.660172">
            </div>
          </div>
          <div class="form-row">
            <button class="btn-info" id="btn-geo" style="flex: 1;">üìç L·∫•y v·ªã tr√≠ GPS</button>
          </div>
          <div class="form-row" style="margin-top: 8px;">
            <button class="btn-success" id="btn-update-location" style="flex: 1;">üì° C·∫≠p nh·∫≠t v·ªã tr√≠</button>
          </div>
          <div id="location-status" class="notification info" style="display: none; margin-top: 12px; margin-bottom: 0;">
            Ch∆∞a c·∫≠p nh·∫≠t v·ªã tr√≠
          </div>
        </div>

        <div class="card" style="margin-top: 16px;">
          <h2>üéõÔ∏è Tr·∫°ng th√°i ho·∫°t ƒë·ªông</h2>
          <div class="form-row">
            <button class="btn-success" id="btn-online" style="flex: 1;">üü¢ ONLINE</button>
            <button class="btn-warning" id="btn-busy" style="flex: 1;">üü° BUSY</button>
            <button class="btn-secondary" id="btn-offline" style="flex: 1;">‚ö´ OFFLINE</button>
          </div>
        </div>

        <div class="card" style="margin-top: 16px;">
          <h2>üìä Th·ªëng k√™</h2>
          <div class="stats">
            <div class="stat-card">
              <div class="stat-value" id="stat-rides">0</div>
              <div class="stat-label">Chuy·∫øn ƒëi</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="stat-offers">0</div>
              <div class="stat-label">L·ªùi m·ªùi</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div>
        <div class="card">
          <h2>üîî Th√¥ng b√°o th·ªùi gian th·ª±c (SSE)</h2>
          <div id="sse-status" class="notification info">
            Ch∆∞a k·∫øt n·ªëi SSE
          </div>
          <div class="form-row">
            <button class="btn-primary" id="btn-start-sse" style="flex: 1;">üîå K·∫øt n·ªëi SSE</button>
            <button class="btn-danger" id="btn-stop-sse" style="flex: 1;" disabled>‚ùå Ng·∫Øt SSE</button>
          </div>
        </div>

        <div class="card" style="margin-top: 16px;" id="current-ride-card">
          <h2>üöñ Chuy·∫øn ƒëi hi·ªán t·∫°i</h2>
          <div id="ride-status" class="notification info">
            Kh√¥ng c√≥ chuy·∫øn ƒëi
          </div>
          <div id="ride-details" style="display: none; margin: 12px 0; font-size: 13px;">
            <p><strong>Ride ID:</strong> <span id="ride-id">-</span></p>
            <p><strong>Booking ID:</strong> <span id="booking-id">-</span></p>
            <p><strong>Tr·∫°ng th√°i:</strong> <span id="ride-state" class="status-badge status-offline">OFFERED</span></p>
          </div>
          <div class="form-row" id="ride-actions" style="display: none;">
            <button class="btn-success" id="btn-accept" style="flex: 1;">‚úÖ Accept</button>
            <button class="btn-danger" id="btn-reject" style="flex: 1;">‚ùå Reject</button>
          </div>
          <div class="form-row" id="complete-action" style="display: none;">
            <button class="btn-warning" id="btn-complete" style="flex: 1;">üèÅ Complete Ride</button>
          </div>
        </div>

        <div class="card" style="margin-top: 16px;">
          <h2>üìù Event Log</h2>
          <div id="sse-log"></div>
        </div>

        <div class="card" style="margin-top: 16px;">
          <h2>üîß Debug Info</h2>
          <pre id="debug-info">{
  "driverId": "-",
  "status": "OFFLINE",
  "location": null,
  "vehicleType": "-"
}</pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const DRIVER_API = 'http://localhost:8004';
    const RIDE_API = 'http://localhost:8005';
    const SSE_API = 'http://localhost:8006';

    // State
    let currentDriverId = null;
    let currentVehicleType = 'CAR_4';
    let currentStatus = 'OFFLINE';
    let eventSource = null;
    let stats = { rides: 0, offers: 0 };
    let currentRide = null; // { rideId, bookingId, state: 'OFFERED'|'ACCEPTED'|'COMPLETED' }

    // DOM Elements
    const $ = (id) => document.getElementById(id);

    // Utility Functions
    function updateUI() {
      $('display-driver-id').textContent = currentDriverId || '-';
      $('driver-avatar').textContent = currentDriverId ? currentDriverId.toUpperCase()[0] : 'D';
      
      const badge = $('status-badge');
      badge.textContent = currentStatus;
      badge.className = `status-badge status-${currentStatus.toLowerCase()}`;
      
      $('debug-info').textContent = JSON.stringify({
        driverId: currentDriverId,
        status: currentStatus,
        location: {
          lat: parseFloat($('lat').value),
          lng: parseFloat($('lng').value)
        },
        vehicleType: currentVehicleType
      }, null, 2);

      $('stat-rides').textContent = stats.rides;
      $('stat-offers').textContent = stats.offers;
    }

    function addLog(message, type = 'info') {
      const log = $('sse-log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
      log.insertBefore(entry, log.firstChild);
      
      // Keep only last 50 entries
      while (log.children.length > 50) {
        log.removeChild(log.lastChild);
      }
    }

    function showNotification(element, message, type = 'info') {
      element.style.display = 'block';
      element.className = `notification ${type}`;
      element.textContent = message;
    }

    // Apply driver configuration
    $('btn-apply').onclick = async () => {
      const driverId = $('driver-id').value.trim();
      const vehicleType = $('vehicle-type').value;
      
      if (!driverId) {
        alert('Vui l√≤ng nh·∫≠p Driver ID!');
        return;
      }
      
      // Set vehicleType via /drivers/me/status first
      try {
        const response = await fetch(`${DRIVER_API}/drivers/me/status`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-driver-id': driverId
          },
          body: JSON.stringify({
            status: 'ONLINE',
            vehicleType: vehicleType
          })
        });

        const data = await response.json();
        
        if (response.ok) {
          currentDriverId = driverId;
          currentVehicleType = vehicleType;
          currentStatus = 'ONLINE';
          addLog(`‚úÖ Driver ${driverId} configured: ${vehicleType}, status: ONLINE`, 'success');
          updateUI();
        } else {
          alert(`L·ªói: ${data.error || 'Unknown error'}`);
          addLog(`‚ùå Config failed: ${data.error}`, 'error');
        }
      } catch (err) {
        alert(`L·ªói k·∫øt n·ªëi: ${err.message}`);
        addLog(`‚ùå Connection error: ${err.message}`, 'error');
      }
    };

    // Get current GPS location
    $('btn-geo').onclick = () => {
      if (!navigator.geolocation) {
        alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS');
        return;
      }
      
      addLog('ƒêang l·∫•y v·ªã tr√≠ GPS...', 'info');
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          $('lat').value = pos.coords.latitude.toFixed(6);
          $('lng').value = pos.coords.longitude.toFixed(6);
          addLog(`GPS: ${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`, 'success');
          updateUI();
        },
        (err) => {
          addLog(`GPS Error: ${err.message}`, 'error');
        }
      );
    };

    // Update location to server
    $('btn-update-location').onclick = async () => {
      if (!currentDriverId) {
        alert('Vui l√≤ng c·∫•u h√¨nh Driver tr∆∞·ªõc!');
        return;
      }

      const lat = parseFloat($('lat').value);
      const lng = parseFloat($('lng').value);

      if (isNaN(lat) || isNaN(lng)) {
        alert('T·ªça ƒë·ªô kh√¥ng h·ª£p l·ªá!');
        return;
      }

      try {
        // Ensure vehicleType is set first (in case user didn't click Apply)
        await fetch(`${DRIVER_API}/drivers/me/status`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-driver-id': currentDriverId
          },
          body: JSON.stringify({
            status: 'ONLINE',
            vehicleType: currentVehicleType
          })
        });

        const response = await fetch(`${DRIVER_API}/drivers/me/location`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-driver-id': currentDriverId
          },
          body: JSON.stringify({
            lat: lat,
            lng: lng
          })
        });

        const data = await response.json();
        
        if (response.ok) {
          showNotification($('location-status'), `‚úÖ V·ªã tr√≠ ƒë√£ c·∫≠p nh·∫≠t: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 'success');
          addLog(`Location updated: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 'success');
          currentStatus = data.state || 'ONLINE';
          updateUI();
        } else {
          showNotification($('location-status'), `‚ùå L·ªói: ${data.error || 'Unknown error'}`, 'error');
          addLog(`Location update failed: ${data.error}`, 'error');
        }
      } catch (err) {
        showNotification($('location-status'), `‚ùå L·ªói k·∫øt n·ªëi: ${err.message}`, 'error');
        addLog(`Connection error: ${err.message}`, 'error');
      }
    };

    // Change driver status
    async function changeStatus(newStatus) {
      if (!currentDriverId) {
        alert('Vui l√≤ng c·∫•u h√¨nh Driver tr∆∞·ªõc!');
        return;
      }

      try {
        const response = await fetch(`${DRIVER_API}/drivers/me/status`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-driver-id': currentDriverId
          },
          body: JSON.stringify({
            status: newStatus
          })
        });

        const data = await response.json();
        
        if (response.ok) {
          currentStatus = newStatus;
          addLog(`Status changed to ${newStatus}`, 'success');
          updateUI();
        } else {
          addLog(`Status change failed: ${data.error}`, 'error');
        }
      } catch (err) {
        addLog(`Connection error: ${err.message}`, 'error');
      }
    }

    $('btn-online').onclick = () => changeStatus('ONLINE');
    $('btn-busy').onclick = () => changeStatus('BUSY');
    $('btn-offline').onclick = () => changeStatus('OFFLINE');

    // SSE Connection
    $('btn-start-sse').onclick = () => {
      if (!currentDriverId) {
        alert('Vui l√≤ng c·∫•u h√¨nh Driver tr∆∞·ªõc!');
        return;
      }

      if (eventSource) {
        eventSource.close();
      }

      const url = `${SSE_API}/notifications/stream?role=DRIVER&driverId=${currentDriverId}`;
      eventSource = new EventSource(url);

      showNotification($('sse-status'), 'üîÑ ƒêang k·∫øt n·ªëi SSE...', 'info');
      addLog(`Connecting to SSE: ${url}`, 'info');

      eventSource.onopen = () => {
        showNotification($('sse-status'), '‚úÖ SSE ƒë√£ k·∫øt n·ªëi th√†nh c√¥ng!', 'success');
        addLog('SSE connected successfully', 'success');
        $('btn-start-sse').disabled = true;
        $('btn-stop-sse').disabled = false;
      };

      eventSource.onerror = (err) => {
        showNotification($('sse-status'), '‚ùå L·ªói k·∫øt n·ªëi SSE', 'error');
        addLog('SSE connection error', 'error');
        console.error('SSE Error:', err);
      };

      // Ride offer event
      eventSource.addEventListener('ride_offer', (e) => {
        const data = JSON.parse(e.data);
        const payload = data.payload || {};
        const rideId = payload.rideId || 'N/A';
        const bookingId = payload.bookingId || 'N/A';
        
        stats.offers++;
        
        // Store current ride
        currentRide = {
          rideId: rideId,
          bookingId: bookingId,
          state: 'OFFERED'
        };
        
        // Show ride details and action buttons
        $('ride-id').textContent = rideId.substring(0, 16) + '...';
        $('booking-id').textContent = bookingId.substring(0, 16) + '...';
        $('ride-state').textContent = 'OFFERED';
        $('ride-state').className = 'status-badge status-warning';
        
        $('ride-details').style.display = 'block';
        $('ride-actions').style.display = 'flex';
        $('complete-action').style.display = 'none';
        
        showNotification($('ride-status'), `üöó L·ªùi m·ªùi chuy·∫øn ƒëi m·ªõi! Ride: ${rideId.substring(0, 8)}...`, 'warning');
        addLog(`üöó <strong>RIDE OFFER</strong> - Ride: ${rideId.substring(0, 8)}... | Booking: ${bookingId.substring(0, 8)}...`, 'ride_offer');
        
        updateUI();
      });

      // Ride accepted event
      eventSource.addEventListener('ride_accepted', (e) => {
        const data = JSON.parse(e.data);
        const payload = data.payload || {};
        
        stats.rides++;
        
        // Update current ride state
        if (currentRide && currentRide.rideId === payload.rideId) {
          currentRide.state = 'ACCEPTED';
          $('ride-state').textContent = 'ACCEPTED';
          $('ride-state').className = 'status-badge status-success';
          
          $('ride-actions').style.display = 'none';
          $('complete-action').style.display = 'flex';
          
          showNotification($('ride-status'), `‚úÖ B·∫°n ƒë√£ nh·∫≠n chuy·∫øn ƒëi!`, 'success');
        }
        
        addLog(`‚úÖ <strong>RIDE ACCEPTED</strong> - Ride: ${payload.rideId?.substring(0, 8)}...`, 'ride_accepted');
        updateUI();
      });

      // Ride completed event
      eventSource.addEventListener('ride_completed', (e) => {
        const data = JSON.parse(e.data);
        const payload = data.payload || {};
        
        // Clear current ride
        if (currentRide && currentRide.rideId === payload.rideId) {
          currentRide = null;
          $('ride-details').style.display = 'none';
          $('ride-actions').style.display = 'none';
          $('complete-action').style.display = 'none';
          showNotification($('ride-status'), `üèÅ Chuy·∫øn ƒëi ƒë√£ ho√†n th√†nh!`, 'info');
        }
        
        addLog(`üèÅ <strong>RIDE COMPLETED</strong> - Ride: ${payload.rideId?.substring(0, 8)}...`, 'ride_completed');
      });

      // Heartbeat
      eventSource.addEventListener('ping', () => {
        console.log('SSE heartbeat');
      });
    };

    $('btn-stop-sse').onclick = () => {
      if (eventSource) {
        eventSource.close();
        eventSource = null;
        showNotification($('sse-status'), '‚ö´ SSE ƒë√£ ng·∫Øt k·∫øt n·ªëi', 'warning');
        addLog('SSE disconnected', 'warning');
        $('btn-start-sse').disabled = false;
        $('btn-stop-sse').disabled = true;
      }
    };

    // Ride action handlers
    $('btn-accept').onclick = async () => {
      if (!currentRide || !currentDriverId) return;
      
      try {
        addLog(`Accepting ride ${currentRide.rideId.substring(0, 8)}...`, 'info');
        
        const response = await fetch(`${RIDE_API}/rides/${currentRide.rideId}/driver/accept`, {
          method: 'POST',
          headers: {
            'x-driver-id': currentDriverId
          }
        });

        const data = await response.json();
        
        if (response.ok) {
          addLog(`‚úÖ Accepted ride ${currentRide.rideId.substring(0, 8)}`, 'success');
          // State will be updated via SSE ride_accepted event
        } else {
          addLog(`‚ùå Failed to accept: ${data.error}`, 'error');
          showNotification($('ride-status'), `‚ùå L·ªói: ${data.error}`, 'error');
        }
      } catch (err) {
        addLog(`‚ùå Accept error: ${err.message}`, 'error');
        showNotification($('ride-status'), `‚ùå L·ªói k·∫øt n·ªëi: ${err.message}`, 'error');
      }
    };

    $('btn-reject').onclick = async () => {
      if (!currentRide || !currentDriverId) return;
      
      try {
        addLog(`Rejecting ride ${currentRide.rideId.substring(0, 8)}...`, 'info');
        
        const response = await fetch(`${RIDE_API}/rides/${currentRide.rideId}/driver/reject`, {
          method: 'POST',
          headers: {
            'x-driver-id': currentDriverId
          }
        });

        const data = await response.json();
        
        if (response.ok) {
          addLog(`‚ùå Rejected ride ${currentRide.rideId.substring(0, 8)}`, 'warning');
          
          // Clear current ride
          currentRide = null;
          $('ride-details').style.display = 'none';
          $('ride-actions').style.display = 'none';
          showNotification($('ride-status'), `‚ùå ƒê√£ t·ª´ ch·ªëi chuy·∫øn ƒëi`, 'warning');
        } else {
          addLog(`‚ùå Failed to reject: ${data.error}`, 'error');
          showNotification($('ride-status'), `‚ùå L·ªói: ${data.error}`, 'error');
        }
      } catch (err) {
        addLog(`‚ùå Reject error: ${err.message}`, 'error');
        showNotification($('ride-status'), `‚ùå L·ªói k·∫øt n·ªëi: ${err.message}`, 'error');
      }
    };

    $('btn-complete').onclick = async () => {
      if (!currentRide || !currentDriverId) return;
      
      try {
        addLog(`Completing ride ${currentRide.rideId.substring(0, 8)}...`, 'info');
        
        const response = await fetch(`${RIDE_API}/rides/${currentRide.rideId}/complete`, {
          method: 'POST',
          headers: {
            'x-driver-id': currentDriverId
          }
        });

        const data = await response.json();
        
        if (response.ok) {
          addLog(`üèÅ Completed ride ${currentRide.rideId.substring(0, 8)}`, 'success');
          // State will be updated via SSE ride_completed event
        } else {
          addLog(`‚ùå Failed to complete: ${data.error}`, 'error');
          showNotification($('ride-status'), `‚ùå L·ªói: ${data.error}`, 'error');
        }
      } catch (err) {
        addLog(`‚ùå Complete error: ${err.message}`, 'error');
        showNotification($('ride-status'), `‚ùå L·ªói k·∫øt n·ªëi: ${err.message}`, 'error');
      }
    };

    // Initialize
    updateUI();
    addLog('Driver Dashboard initialized', 'info');
  </script>
</body>
</html>
