services:
  db:
    image: mysql:8.0
    container_name: mysql_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: mydatabase
      MYSQL_USER: my_user
      MYSQL_PASSWORD: my_password
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost", "-uroot", "-proot_password"]
      interval: 10s   # Kiểm tra mỗi 10 giây
      timeout: 5s     # Quá 5 giây không phản hồi coi như lỗi
      retries: 5      # Thử lại 5 lần trước khi báo Unhealthy
    networks:
      - cab_network

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: phpmyadmin_gui
    restart: always
    ports:
      - "8080:80"
    environment:
      PMA_HOST: db
      PMA_USER: root
      PMA_PASSWORD: root_password
    depends_on:
      - db
    networks:
      - cab_network

  payment-service:
    build:
      context: .
      dockerfile: ./services/payment-service/Dockerfile
    container_name: payment-service
    restart: always
    ports:
      - "3006:3006"
    environment:
      PORT: 3006
      DB_HOST: db
      DB_USER: my_user
      DB_PASS: my_password
      DB_NAME: payment_db
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
      RIDE_SERVICE_URL: http://ride-service:3004
      VNP_TMN_CODE: your_vnpay_tmn_code
      VNP_HASH_SECRET: your_vnpay_hash_secret
      VNP_URL: https://sandbox.vnpayment.vn/paymentv2/vpcpay.html
      VNP_RETURN_URL: http://localhost:5173/payment/result
      VNP_IPN_URL: http://localhost:3006/payments/vnpay/ipn
    depends_on:
      db:
        condition: service_healthy
    networks:
      - cab_network

  auth-service:
    build:
      context: .
      dockerfile: ./services/auth-service/Dockerfile
    container_name: auth-service
    restart: always
    ports:
      - "3001:3001"
    environment:
      PORT: 3001
      DB_HOST: db
      DB_USER: my_user
      DB_PASS: my_password
      DB_NAME: auth_db
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
      JWT_EXPIRES_IN: 15m
      REFRESH_TOKEN_EXPIRES_IN: 30d
      USER_SERVICE_URL: http://user-service:3002
    depends_on:
      db:
        condition: service_healthy
    networks:
      - cab_network

  user-service:
    build:
      context: .
      dockerfile: ./services/user-service/Dockerfile
    container_name: user-service
    restart: always
    ports:
      - "3002:3002"
    environment:
      PORT: 3002
      DB_HOST: db
      DB_USER: my_user
      DB_PASS: my_password
      DB_NAME: user_db
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
    depends_on:
      db:
        condition: service_healthy
    networks:
      - cab_network

  booking-service:
    build:
      context: .
      dockerfile: ./services/booking-service/Dockerfile
    container_name: booking-service
    restart: always
    ports:
      - "3003:3003"
    environment:
      PORT: 3003
      DB_HOST: db
      DB_USER: my_user
      DB_PASS: my_password
      DB_NAME: booking_db
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
      PRICING_SERVICE_URL: http://pricing-service:3007
      DRIVER_SERVICE_URL: http://driver-service:3005
      RIDE_SERVICE_URL: http://ride-service:3004
    depends_on:
      db:
        condition: service_healthy
    networks:
      - cab_network

  ride-service:
    build:
      context: .
      dockerfile: ./services/ride-service/Dockerfile
    container_name: ride-service
    restart: always
    ports:
      - "3004:3004"
    environment:
      PORT: 3004
      DB_HOST: db
      DB_USER: my_user
      DB_PASS: my_password
      DB_NAME: ride_db
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
      PRICING_SERVICE_URL: http://pricing-service:3007
    depends_on:
      db:
        condition: service_healthy
    networks:
      - cab_network

  driver-service:
    build:
      context: .
      dockerfile: ./services/driver-service/Dockerfile
    container_name: driver-service
    restart: always
    ports:
      - "3005:3005"
    environment:
      PORT: 3005
      DB_HOST: db
      DB_USER: my_user
      DB_PASS: my_password
      DB_NAME: driver_db
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
    depends_on:
      db:
        condition: service_healthy
    networks:
      - cab_network

  pricing-service:
    build:
      context: .
      dockerfile: ./services/pricing-service/Dockerfile
    container_name: pricing-service
    restart: always
    ports:
      - "3007:3007"
    environment:
      PORT: 3007
      DB_HOST: db
      DB_USER: my_user
      DB_PASS: my_password
      DB_NAME: pricing_db
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
      DEFAULT_RULE_ID: '00000000-0000-0000-0000-000000000001'
    depends_on:
      db:
        condition: service_healthy
    networks:
      - cab_network

  review-service:
    build:
      context: ./services/review-service
      dockerfile: Dockerfile
    container_name: review-service
    restart: always
    ports:
      - "3008:3008"
    environment:
      PORT: 3008
    networks:
      - cab_network

  notification-service:
    build:
      context: ./services/notification-service
      dockerfile: Dockerfile
    container_name: notification-service
    restart: always
    ports:
      - "3009:3009"
    environment:
      PORT: 3009
    networks:
      - cab_network

  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    restart: always
    ports:
      - "3000:3000"
    environment:
      PORT: 3000
      AUTH_SERVICE_URL: http://auth-service:3001
      USER_SERVICE_URL: http://user-service:3002
      BOOKING_SERVICE_URL: http://booking-service:3003
      RIDE_SERVICE_URL: http://ride-service:3004
      DRIVER_SERVICE_URL: http://driver-service:3005
      PAYMENT_SERVICE_URL: http://payment-service:3006
      PRICING_SERVICE_URL: http://pricing-service:3007
      REVIEW_SERVICE_URL: http://review-service:3008
      NOTIFICATION_SERVICE_URL: http://notification-service:3009
    depends_on:
      - auth-service
      - user-service
      - booking-service
      - ride-service
      - driver-service
      - payment-service
      - pricing-service
      - review-service
      - notification-service
    networks:
      - cab_network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    restart: always
    ports:
      - "5173:5173"
    environment:
      VITE_API_BASE_URL: http://localhost:3000
    volumes:
      # Mount source code for hot reload in development
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      # Don't mount node_modules
      - /app/node_modules
    depends_on:
      - api-gateway
    networks:
      - cab_network
    
volumes:
  mysql_data:

networks:
  cab_network:
    driver: bridge